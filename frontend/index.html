<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slate.Tattoo - AI Tattoo Visualization</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- Import map for Three.js -->
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
        "three/": "https://unpkg.com/three@0.165.0/"
      }
    }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script> 
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>Slate.Tattoo</h1>
                <span class="tagline">AI Tattoo Platform</span> </div>
            <div class="nav-menu">
                <span id="userInfo" class="user-info"></span>
                <button id="logoutBtn" class="btn btn-outline" style="display:none;">Logout</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section id="styleSelectionSection" class="section">
                <div class="section-header">
                    <h2>Slate.Tattoo ‚Äì Try Before You Dye</h2>
                    <p>Explore curated tattoo stencils from top artists. Choose a style to begin.</p>
                </div>
                <div class="style-chips">
                    <!-- This will be populated by JavaScript -->
                </div>
                <div class="upload-link-container">
                    <input type="file" id="stencilFileInput" accept="image/jpeg,image/png,image/webp" hidden>
                    <a href="#" id="uploadStencilLink">Or, upload your own stencil</a>
                </div>
            </section>
            
            <section id="skinPhotoUploadSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Upload Your Photo</h2>
                    <p>Choose a photo where you want the tattoo</p>
                </div>

                <div id="selectedStencilPreview" class="image-preview" style="display: none; margin-bottom: 2rem;">
                    <h4>Your Chosen Stencil:</h4>
                    <img id="selectedStencilPreviewImg" src="" alt="Selected Stencil Preview" style="max-width: 200px;">
                </div>
                
                <div class="upload-area" id="skinUploadArea">
                    <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" hidden>
                    <div class="upload-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p>Click to upload or drag and drop</p>
                        <span>PNG, JPG or WebP (max. 5MB)</span>
                    </div>
                </div>

            </section>

            <section id="drawingSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Position Your Tattoo</h2>
                    <p>Drag, resize, and rotate the tattoo to place it on the skin.</p>
                </div>
                
                <div class="drawing-container">
                    <canvas id="drawingCanvas"></canvas>
                </div>

                <div class="drawing-tools">
                    <button id="changeSkinPhotoBtn" class="btn btn-outline btn-sm">Change Skin Photo</button>
                    <div class="rotation-control">
                        <label for="rotationSlider">Rotate Tattoo: <span id="rotationValue">0¬∞</span></label>
                        <input type="range" id="rotationSlider" min="-180" max="180" value="0">
                    </div>
                    <div class="size-control" style="margin-left: 1rem;">
                        <label for="sizeSlider">Resize Tattoo: <span id="sizeValue">100%</span></label>
                        <input type="range" id="sizeSlider" min="20" max="200" value="100">
                    </div>
                </div>

                <button id="continueBtn" class="btn btn-primary" style="margin-top: 2rem; display: block; margin-left: auto; margin-right: auto;">Generate Tattoo on Skin</button>
            </section>
            
            <section id="designSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Refine & Generate</h2>
                    <p>Final adjustments for placement</p>
                </div>

                <div class="credits-info">
                    <span id="creditsRemaining"></span>
                </div>

                <div id="socialShare" style="margin-top: 1rem; display: none;">
                    <button id="shareToInstagramBtn" class="btn btn-secondary">Share to Instagram</button>
                </div>
            </section>

            <section id="resultsSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Your Tattoo Designs</h2>
                    <p>Here are your AI-generated tattoo previews</p>
                </div>

                <div class="results-grid">
                </div>

                <div id="artistContactSection" class="artist-contact-section" style="display: none; text-align: center; margin-top: 2rem;">
                    <a id="whatsappLink" href="#" target="_blank" class="btn btn-primary btn-lg">Contact Artist on WhatsApp</a>
                </div>

                <div class="results-actions">
                    <button id="downloadAllBtn" class="btn btn-primary">Download All</button>
                    <button id="newDesignBtn" class="btn btn-outline">Start New Design</button>
                </div>
            </section>
            
            <section id="artistsSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Find Your Artist</h2>
                    <p>Connect with talented tattoo artists who can bring your design to life</p>
                </div>

                <div class="filters">
                    <select id="locationFilter" class="filter-select">
                        <option value="">All Locations</option>
                        <option value="Los Angeles, CA">Los Angeles, CA</option>
                        <option value="New York, NY">New York, NY</option>
                        <option value="Austin, TX">Austin, TX</option>
                        <option value="Miami, FL">Miami, FL</option>
                        <option value="Seattle, WA">Seattle, WA</option>
                        <option value="Denver, CO">Denver, CO</option>
                        <option value="Portland, OR">Portland, OR</option>
                        <option value="Chicago, IL">Chicago, IL</option>
                    </select>
                    <select id="styleFilter" class="filter-select">
                        <option value="">All Styles</option>
                        <option value="Traditional">Traditional</option>
                        <option value="Neo-Traditional">Neo-Traditional</option>
                        <option value="Realism">Realism</option>
                        <option value="Blackwork">Blackwork</option>
                        <option value="Watercolor">Watercolor</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Minimalist">Minimalist</option>
                        <option value="Geometric">Geometric</option>
                        <option value="Fine Line">Fine Line</option>
                        <option value="Tribal">Tribal</option>
                    </select>
                </div>

                <div id="artistsGrid" class="artists-grid">
                </div>
            </section>
        </div>
    </main>

    <div id="stencilModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h2 id="stencilModalTitle"></h2>
            <div id="stencilGrid" class="sketch-grid">
                <!-- Stencils will be dynamically loaded here -->
            </div>
            <button id="closeStencilModalBtn" class="btn btn-outline" style="margin-top: 1rem;">Close</button>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Generating your tattoo designs...</p>
            <div id="artistInfo" class="artist-info-loading" style="display: none;">
                <h4>While you wait, meet the artist:</h4>
                <p id="artistName"></p>
                <div id="artistSketchesGrid" class="artist-sketches-grid"></div>
                <a id="artistWhatsappLink" href="#" target="_blank" class="btn btn-primary btn-sm" style="margin-top: 1rem;">Contact Artist on WhatsApp</a>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Slate.Tattoo</h3>
                    <p>AI-powered tattoo visualization platform</p>
                </div>
                <div class="footer-section">
                    <h4>Features</h4>
                    <ul>
                        <li>AI Tattoo Generation</li>
                        <li>20+ Tattoo Styles</li>
                        <li>Artist Discovery</li>
                        <li>Direct WhatsApp Contact</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Coming Soon</h4>
                    <ul>
                        <li>Real AI Generation</li>
                        <li>Payment Integration</li>
                        <li>Artist Profiles</li>
                        <li>Mobile App</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Slate.Tattoo. Made with ‚ù§Ô∏è by itayash@gmail.com</p>
            </div>
        </div>
    </footer>
    <script>console.log('Loading config.js...');</script>
    <script src="js/config.js"></script>
    <script>console.log('Loading auth.js...');</script>
    <script src="js/auth.js"></script>
    <script>console.log('Loading drawing.js...');</script>
    <script type="module" src="js/drawing.js"></script>
    <script type="module">
        console.log('Main inline script starting...');

        async function logUserEvent(eventType, artistId, stencilId) {
            if (!STATE.token) return; // Don't log events for anonymous users

            try {
                await fetch(`${CONFIG.API_URL}/log-event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${STATE.token}`
                    },
                    body: JSON.stringify({
                        event_type: eventType,
                        artist_id: artistId,
                        stencil_id: stencilId
                    })
                });
            } catch (error) {
                console.warn('Failed to log user event:', error);
            }
        }

        /**
         * Resizes an image Data URL to a maximum width/height while maintaining aspect ratio.
         * Returns a Promise that resolves with the new Data URL.
         * @param {string} dataURL The input image data URL.
         * @param {string} originalMimeType The original MIME type of the file (e.g., 'image/png').
         * @param {number} maxWidth Max width for the resized image.
         * @param {number} maxHeight Max height for the resized image.
         * @param {number} quality JPEG compression quality (0-1), ignored for PNG.
         * @returns {Promise<string>} Promise resolving with the resized image Data URL.
         */
        function resizeImage(dataURL, originalMimeType, maxWidth, maxHeight, quality = 0.9) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // Crucial for transparency: Clear canvas to transparent black
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // Clears to transparent black

                    ctx.drawImage(img, 0, 0, width, height);

                    // If original was PNG or WebP, aim for PNG output to preserve transparency, otherwise JPEG
                    const outputMimeType = (originalMimeType === 'image/png' || originalMimeType === 'image/webp') ? 'image/png' : 'image/jpeg';
                    const outputQuality = outputMimeType === 'image/jpeg' ? quality : undefined;

                    resolve(canvas.toDataURL(outputMimeType, outputQuality));
                };
                img.src = dataURL;
            });
        }


        // --- Artist Loading and Filtering Functions (MOVED TO GLOBAL SCOPE) ---
        let allArtists = []; // Declare in a scope accessible by filterArtists and displayArtists

        // Function definitions for contactArtist, changePortfolioImage, loadDemoArtistsWithFilter,
        // displayArtists, and filterArtists are assigned to window for global accessibility
        window.contactArtist = function(whatsapp, name) {
            const message = `Hi ${name}, I'm interested in getting a tattoo! Can you help me visualize this? (from SkinTip.AI)`;
            window.open(`https://wa.me/${whatsapp}?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.changePortfolioImage = function(button, direction) {
            const gallery = button.closest('.portfolio-gallery');
            const images = Array.from(gallery.querySelectorAll('.portfolio-image'));
            let currentIndex = images.findIndex(img => img.classList.contains('active'));

            images[currentIndex].style.display = 'none';
            images[currentIndex].classList.remove('active');

            currentIndex = (currentIndex + direction + images.length) % images.length;

            images[currentIndex].style.display = 'block';
            images[currentIndex].classList.add('active');
        };

        window.loadDemoArtistsWithFilter = function() {
            allArtists = [
                {
                    name: 'Sarah Martinez',
                    location: 'Los Angeles, CA',
                    styles: ['Fine Line', 'Minimalist', 'Geometric'],
                    bio: 'Specializing in delicate designs with 10+ years experience',
                    likes: 234,
                    whatsapp: '+1234567890',
                    portfolio: [
                        'https://images.unsplash.com/photo-1611501275019-9b5cda994e8d',
                        'https://images.unsplash.com/photo-1598371839696-5c5bb00bdc28',
                        'https://images.unsplash.com/photo-1567406889330-43e4639e8d4f',
                        'https://images.unsplash.com/photo-1475695752828-6d2b0a83cf8a'
                    ]
                },
                {
                    name: 'Mike Chen',
                    location: 'New York, NY',
                    styles: ['Japanese', 'Neo-Traditional'],
                    bio: 'Award-winning traditional Japanese artist',
                    likes: 189,
                    whatsapp: '+0987654321',
                    portfolio: [
                        'https://images.unsplash.com/photo-1565058379802-bbe93b2f703a',
                        'https://images.unsplash.com/photo-1540202403-b7abd6747a18',
                        'https://images.unsplash.com/photo-1582736317441-e6937f84b6b3',
                        'https://images.unsplash.com/photo-1552627019-947c3789ffb5'
                    ]
                },
                {
                    name: 'Emma Thompson',
                    location: 'Austin, TX',
                    styles: ['Watercolor', 'Abstract'],
                    bio: 'Creating unique watercolor tattoos since 2015',
                    likes: 156,
                    whatsapp: '+1122334455',
                    portfolio: [
                        'https://images.unsplash.com/photo-1598371839696-5c5bb00bdc28',
                        'https://images.unsplash.com/photo-1604881991720-f91add269bed',
                        'https://images.unsplash.com/photo-1590736969955-71cc94901144',
                        'https://images.unsplash.com/photo-1611501275019-9b5cda994e8d'
                    ]
                },
                {
                    name: 'Carlos Rodriguez',
                    location: 'Miami, FL',
                    styles: ['Blackwork', 'Geometric', 'Tribal'],
                    bio: 'Bold designs with precision and passion',
                    likes: 298,
                    whatsapp: '+9988776655',
                    portfolio: [
                        'https://images.unsplash.com/photo-1590736969955-71cc94901144',
                        'https://images.unsplash.com/photo-1568515045052-f9a854d70bfd',
                        'https://images.unsplash.com/photo-1582731478949-884de7283343',
                        'https://images.unsplash.com/photo-1604881991720-f91add269bed'
                ]
                }
            ]; // Correctly closing allArtists array
            window.displayArtists(allArtists);
        };

        window.displayArtists = function(artists) {
            const artistsGrid = document.getElementById('artistsGrid');
            if (artists.length === 0) {
                artistsGrid.innerHTML = '<div class="empty-state"><p>No artists found matching your criteria</p></div>';
                return;
            }
            artistsGrid.innerHTML = artists.map(artist => {
                let portfolioImages = '';
                if (Array.isArray(artist.portfolio)) {
                    portfolioImages = artist.portfolio.map((img, index) =>
                        `<img src="${img}" alt="${artist.name} work ${index + 1}"
                             class="portfolio-image ${index === 0 ? 'active' : ''}"
                             style="display: ${index === 0 ? 'block' : 'none'}">`
                    ).join('');
                } else {
                    portfolioImages = `<img src="${artist.portfolio}" alt="${artist.name}" class="portfolio-image active" style="display: block">`;
                }
                const stylesHTML = artist.styles.map(style =>
                    `<span class="style-tag">${style}</span>`
                ).join('');
                return `
                    <div class="artist-card">
                        <div class="portfolio-gallery">
                            ${portfolioImages}
                            <button class="gallery-prev" onclick="changePortfolioImage(this, -1)">‚Äπ</button>
                            <button class="gallery-next" onclick="changePortfolioImage(this, 1)">‚Ä∫</button>
                        </div>
                        <div class="artist-info">
                            <h3>${artist.name}</h3>
                            <p class="artist-location">üìç ${artist.location}</p>
                            <p class="artist-bio">${artist.bio}</p>
                            <div class="artist-styles">
                                ${stylesHTML}
                            </div>
                            <div class="artist-footer">
                                <span class="artist-likes">‚ù§Ô∏è ${artist.likes}</span>
                                <button class="btn btn-primary btn-sm" onclick="contactArtist('${artist.whatsapp}', '${artist.name}')">
                                    Contact via WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.filterArtists = function() {
            const locationFilter = document.getElementById('locationFilter');
            const styleFilter = document.getElementById('styleFilter');
            const selectedLocation = locationFilter ? locationFilter.value : '';
            const selectedStyle = styleFilter ? styleFilter.value : '';

            const filtered = allArtists.filter(artist => {
                const matchesLocation = !selectedLocation || artist.location === selectedLocation;
                const matchesStyle = !selectedStyle || artist.styles.includes(selectedStyle);
                return matchesLocation && matchesStyle;
            });
            window.displayArtists(filtered);
        };
        // --- END ARTIST FUNCTIONS GLOBAL SCOPE ---


        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üé® SkinTip initializing (DOMContentLoaded)!');

            let stencilData = {};

            async function fetchStencilData() {
                try {
                    const response = await fetch(`${CONFIG.API_URL}/styles-with-stencils`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch stencil data');
                    }
                    stencilData = await response.json();
                    populateStyleChips();
                } catch (error) {
                    console.error('Error fetching stencil data:', error);
                    utils.showError('Could not load tattoo styles. Please try again later.');
                }
            }

            // --- New User Flow Logic ---
            const styleChipsContainer = document.querySelector('.style-chips');

            function populateStyleChips() {
                for (const style in stencilData) {
                    const styleChipContainer = document.createElement('div');
                    styleChipContainer.className = 'style-chip-container';

                    const button = document.createElement('button');
                    button.className = 'btn btn-primary style-chip';
                    button.dataset.style = style;
                    button.textContent = style;
                    if (style === 'Freestyle') {
                        button.classList.remove('btn-primary');
                        button.classList.add('btn-secondary');
                    }

                    const tattooOfTheDay = document.createElement('div');
                    tattooOfTheDay.className = 'tattoo-of-the-day clickable';
                    const tattooOfTheDayTitle = document.createElement('div');
                    tattooOfTheDayTitle.className = 'tattoo-of-the-day-title';

                    const firstStencil = stencilData[style][0];
                    if (firstStencil) {
                        tattooOfTheDay.dataset.stencilId = firstStencil.id;
                        tattooOfTheDay.innerHTML = `<img src="${firstStencil.imageUrl}" alt="Tattoo of the day for ${style}">`;
                        tattooOfTheDayTitle.innerHTML = `
                            <p><strong>Tattoo of the day:</strong></p>
                            <p>${firstStencil.name}</p>
                            <p>By: ${firstStencil.artist.name}</p>
                        `;
                    }

                    styleChipContainer.appendChild(button);
                    styleChipContainer.appendChild(tattooOfTheDay);
                    styleChipContainer.appendChild(tattooOfTheDayTitle);
                    styleChipsContainer.appendChild(styleChipContainer);
                }
                // Re-select the style chips after they are populated
                const styleChips = document.querySelectorAll('.style-chip');
                styleChips.forEach(chip => {
                    chip.addEventListener('click', () => {
                        const style = chip.dataset.style;
                        stencilModalTitle.textContent = style;
                        populateStencilGrid(style);
                        stencilModal.style.display = 'flex';
                    });
                });
            }

            await fetchStencilData();

            const stencilModal = document.getElementById('stencilModal');
            const stencilModalTitle = document.getElementById('stencilModalTitle');
            const stencilGrid = document.getElementById('stencilGrid');
            const closeStencilModalBtn = document.getElementById('closeStencilModalBtn');

            styleChipsContainer.addEventListener('click', (e) => {
                const tattooOfTheDay = e.target.closest('.tattoo-of-the-day');
                if (tattooOfTheDay) {
                    const stencilId = tattooOfTheDay.dataset.stencilId;
                    if (stencilId) {
                        // Find the stencil in the data
                        let selectedStencil = null;
                        for (const style in stencilData) {
                            const found = stencilData[style].find(s => s.id == stencilId);
                            if (found) {
                                selectedStencil = found;
                                break;
                            }
                        }

                        if (selectedStencil) {
                            logUserEvent('SKETCH_CLICK', selectedStencil.artist.id, selectedStencil.id);
                            STATE.selectedStencil = selectedStencil;

                            // --- Show selected stencil preview ---
                            const selectedStencilPreview = document.getElementById('selectedStencilPreview');
                            const selectedStencilPreviewImg = document.getElementById('selectedStencilPreviewImg');
                            selectedStencilPreviewImg.src = selectedStencil.imageUrl;
                            selectedStencilPreview.style.display = 'block';
                            // ---

                            document.getElementById('styleSelectionSection').style.display = 'none';
                            document.getElementById('skinPhotoUploadSection').style.display = 'block';
                        }
                    }
                }
            });

            function populateStencilGrid(style) {
                stencilGrid.innerHTML = '';
                const stencils = stencilData[style] || [];

                stencils.forEach(stencil => {
                    const sketchCard = document.createElement('div');
                    sketchCard.className = 'sketch-card';
                    sketchCard.dataset.stencilId = stencil.id;
                    sketchCard.innerHTML = `
                        <img src="${stencil.imageUrl}" alt="${stencil.name}">
                        <div class="sketch-card-info">
                            <h4>${stencil.name}</h4>
                            <p>By ${stencil.artist.name}</p>
                        </div>
                    `;
                    stencilGrid.appendChild(sketchCard);
                });
            }

            stencilGrid.addEventListener('click', (e) => {
                const sketchCard = e.target.closest('.sketch-card');
                if (!sketchCard) return;

                const stencilId = sketchCard.dataset.stencilId;

                // Find the stencil in the data
                let selectedStencil = null;
                for (const style in stencilData) {
                    const found = stencilData[style].find(s => s.id === stencilId);
                    if (found) {
                        selectedStencil = found;
                        break;
                    }
                }

                if (selectedStencil) {
                    logUserEvent('SKETCH_CLICK', selectedStencil.artist.id, selectedStencil.id);
                    STATE.selectedStencil = selectedStencil;

                    // --- Show selected stencil preview ---
                    const selectedStencilPreview = document.getElementById('selectedStencilPreview');
                    const selectedStencilPreviewImg = document.getElementById('selectedStencilPreviewImg');
                    selectedStencilPreviewImg.src = selectedStencil.imageUrl;
                    selectedStencilPreview.style.display = 'block';
                    // ---

                    stencilModal.style.display = 'none';
                    document.getElementById('styleSelectionSection').style.display = 'none';
                    document.getElementById('skinPhotoUploadSection').style.display = 'block';
                }
            });

            closeStencilModalBtn.addEventListener('click', () => {
                stencilModal.style.display = 'none';
            });

            // --- Upload Stencil Logic ---
            const uploadStencilLink = document.getElementById('uploadStencilLink');
            const stencilFileInput = document.getElementById('stencilFileInput');

            uploadStencilLink.addEventListener('click', (e) => {
                e.preventDefault();
                stencilFileInput.click();
            });

            stencilFileInput.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    await handleTattooDesignFile(e.target.files[0]);
                }
            });

            async function handleTattooDesignFile(file) {
                if (!CONFIG.ALLOWED_FILE_TYPES.includes(file.type)) {
                    utils.showError('Please upload a JPEG, PNG, or WebP image for your tattoo design.');
                    return;
                }
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    utils.showError('Tattoo design file size must be less than 5MB.');
                    return;
                }
                utils.showLoading('Processing tattoo design...');
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const originalDataURL = e.target.result;
                    const resizedDataURL = await resizeImage(originalDataURL, file.type, 768, 768, 0.9);
                    STATE.uploadedTattooDesignBase64 = resizedDataURL;

                    document.getElementById('styleSelectionSection').style.display = 'none';
                    document.getElementById('skinPhotoUploadSection').style.display = 'block';
                    utils.hideLoading();
                };
                reader.readAsDataURL(file);
            }


            // Initialize auth module (handles redirection for authenticated users)
            if (typeof auth !== 'undefined' && auth.init) {
                auth.init();
            } else {
                console.error("Auth module not loaded or 'auth.init' is not defined.");
            }

            // --- UI Element References ---
            const changeSkinPhotoBtn = document.getElementById('changeSkinPhotoBtn');
            const skinPhotoUploadSection = document.getElementById('skinPhotoUploadSection');
            const skinUploadArea = document.getElementById('skinUploadArea');
            const fileInput = document.getElementById('fileInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const changeImageBtn = document.getElementById('changeImageBtn');

            const drawingSection = document.getElementById('drawingSection');
            const continueBtn = document.getElementById('continueBtn'); // This is now "Generate Tattoo on Skin"

            const designSection = document.getElementById('designSection'); // This section will be hidden/removed
            const creditsRemainingDisplay = document.getElementById('creditsRemaining'); // Keep for token display
            const socialShareDiv = document.getElementById('socialShare');
            const shareToInstagramBtn = document.getElementById('shareToInstagramBtn');
            const resultsSection = document.getElementById('resultsSection');
            const artistsSection = document.getElementById('artistsSection');


            // --- Core Logic & State Management ---

            // Initial UI setup and reset function
            function resetUI() {
                const styleSelectionSection = document.getElementById('styleSelectionSection');
                const selectedStencilPreview = document.getElementById('selectedStencilPreview');
                const skinPhotoUploadSection = document.getElementById('skinPhotoUploadSection');
                const imagePreview = document.getElementById('imagePreview');
                const skinUploadArea = document.getElementById('skinUploadArea');
                const drawingSection = document.getElementById('drawingSection');
                const designSection = document.getElementById('designSection');
                const resultsSection = document.getElementById('resultsSection');
                const artistsSection = document.getElementById('artistsSection');
                const socialShareDiv = document.getElementById('socialShare');
                const fileInput = document.getElementById('fileInput');

                if (styleSelectionSection) styleSelectionSection.style.display = 'block';
                if (selectedStencilPreview) selectedStencilPreview.style.display = 'none';
                if (skinPhotoUploadSection) skinPhotoUploadSection.style.display = 'none';
                if (imagePreview) imagePreview.style.display = 'none';
                if (skinUploadArea) skinUploadArea.style.display = 'flex';
                if (drawingSection) drawingSection.style.display = 'none';
                if (designSection) designSection.style.display = 'none';
                if (resultsSection) resultsSection.style.display = 'none';
                if (artistsSection) artistsSection.style.display = 'none';
                if (socialShareDiv) socialShareDiv.style.display = 'none';
                if (fileInput) fileInput.value = '';


                if (window.drawing && drawing.clearCanvas) {
                    drawing.clearCanvas();
                }
                STATE.selectedStencil = null;
                STATE.uploadedTattooDesignBase64 = null;
                STATE.currentImage = null;
                STATE.currentMask = null;
                STATE.generatedImages = [];

                utils.updateTokenDisplay();
            }

            // --- START Desktop Inactivity Auto-Logout Logic ---
            let inactivityTimeout; // Holds the timer reference

            // Function to reset the timer (called on user activity)
            function resetInactivityTimer() {
                clearTimeout(inactivityTimeout); // Clear any existing timer
                // Only set a new timer if the user is logged in AND it's likely a desktop device
                // This heuristic roughly defines desktop vs mobile by checking for touch support.
                const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0) || (navigator.msMaxTouchPoints > 0);
                
                if (!isTouchDevice) { // Apply auto-logout ONLY if NOT a touch device (assumed desktop)
                    if (STATE.user && STATE.token) { // Only auto-logout if user is currently logged in
                        inactivityTimeout = setTimeout(handleInactivityLogout, CONFIG.DESKTOP_INACTIVITY_TIMEOUT_MS);
                        console.log(`Inactivity timer reset. Auto-logout in ${CONFIG.DESKTOP_INACTIVITY_TIMEOUT_MS / 1000 / 60} minutes.`);
                    } else {
                        console.log("User not logged in or mobile device, inactivity timer not started/reset.");
                    }
                }
            }

            // Function to be called when inactivity timeout is reached
            function handleInactivityLogout() {
                console.log("User inactive for too long. Forcing logout.");
                utils.showError('You have been logged out due to inactivity.');
                // Call the unified logout function from auth.js
                if (typeof auth !== 'undefined' && auth.forceLogoutAndShowModal) {
                    auth.forceLogoutAndShowModal();
                } else {
                    // Fallback for simple logout if auth.js function isn't found
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    STATE.user = null;
                    STATE.token = null;
                    utils.updateTokenDisplay();
                    // window.location.reload(); // Or redirect to login page
                }
            }

            // Set up event listeners for user activity across the document
            const activityEvents = ['mousemove', 'keydown', 'click', 'scroll'];
            activityEvents.forEach(event => {
                document.addEventListener(event, resetInactivityTimer);
            });

            // Initial call to set up the timer when the page finishes loading (if logged in)
            resetInactivityTimer();

            // --- END Desktop Inactivity Auto-Logout Logic ---

            // --- START Main Event Listeners Block (Correctly placed) ---

            changeSkinPhotoBtn?.addEventListener('click', () => {
                drawingSection.style.display = 'none';
                skinPhotoUploadSection.style.display = 'block';
                if (window.drawing && drawing.clearCanvas) {
                    drawing.clearCanvas();
                }
            });

            // Skin Photo Upload 
            skinUploadArea?.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput?.addEventListener('change', async (e) => {
                if (e.target.files.length > 0) {
                    await handleSkinPhotoFile(e.target.files[0]);
                }
            });


            async function handleSkinPhotoFile(file) {
                if (!CONFIG.ALLOWED_FILE_TYPES.includes(file.type)) {
                    utils.showError('Please upload a JPEG, PNG, or WebP image for your skin photo.');
                    return;
                }
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    utils.showError('Skin photo file size must be less than 5MB.');
                    return;
                }

            utils.showLoading('Processing skin photo...');
            const reader = new FileReader();
            reader.onload = async (e) => {
                const originalDataURL = e.target.result;
                // Pass original file type to resizeImage
                const resizedDataURL = await resizeImage(originalDataURL, file.type, 768, 768, 0.8);
                
                const resizedFile = await (await fetch(resizedDataURL)).blob();
                Object.defineProperty(resizedFile, 'name', { value: file.name });
                Object.defineProperty(resizedFile, 'type', { value: file.type }); // Use original file type here!
                STATE.currentImage = resizedFile;

                skinPhotoUploadSection.style.display = 'none';

                if (window.drawing && drawing.init) {
                    const tattooImageUrl = STATE.selectedStencil ? STATE.selectedStencil.imageUrl : STATE.uploadedTattooDesignBase64;
                    if (!tattooImageUrl) {
                        utils.showError('No stencil selected or uploaded. Please go back and choose a stencil or upload one.');
                        return;
                    }
                    // Pass both skin and tattoo image URLs to the new init function
                    drawing.init(resizedDataURL, tattooImageUrl);
                } else {
                    console.error("drawing.js module not loaded correctly or 'drawing' object not exposed.");
                }
                utils.hideLoading();
            };
            reader.readAsDataURL(file);
        }

        // Continue from Drawing to Design (NOW DIRECTLY GENERATES)
        continueBtn?.addEventListener('click', async () => { // Changed to async
            // Ensure user is logged in
            if (!STATE.user || !STATE.token) {
                utils.showError('You must be logged in to generate tattoos.');
                auth.showModal();
                return;
            }

            if (!STATE.userTokens || STATE.userTokens < CONFIG.TOKEN_COSTS.FLUX_PLACEMENT) {
                utils.showError(`Not enough tokens! This action costs ${CONFIG.TOKEN_COSTS.FLUX_PLACEMENT} tokens. You have ${STATE.userTokens || 0}.`);
                return;
            }
            if ((!STATE.selectedStencil && !STATE.uploadedTattooDesignBase64) || !STATE.currentImage) {
                utils.showError('Please ensure you have selected a stencil or uploaded a design, and uploaded a skin photo.');
                return;
            }

            // Generate the mask from the current tattoo position
            if (window.drawing && drawing.updateMask) {
                await drawing.updateMask(); // It's async now because of image cloning
            } else {
                 utils.showError('Drawing module not ready.');
                 return;
            }

            if (!drawing.selectedArea) {
                utils.showError('Could not generate the tattoo mask. Please try again.');
                return;
            }

            STATE.currentMask = drawing.selectedArea;

            // --- Display artist info in loading overlay ---
            const artistInfo = document.getElementById('artistInfo');
            const artistName = document.getElementById('artistName');
            const artistSketchesGrid = document.getElementById('artistSketchesGrid');
            const artistWhatsappLink = document.getElementById('artistWhatsappLink');

            if (STATE.selectedStencil && STATE.selectedStencil.artist) {
                artistName.textContent = STATE.selectedStencil.artist.name;

                // Find other sketches by the same artist
                const artistSketches = [];
                for (const style in stencilData) {
                    stencilData[style].forEach(stencil => {
                        if (stencil.artist.name === STATE.selectedStencil.artist.name && stencil.id !== STATE.selectedStencil.id) {
                            artistSketches.push(stencil);
                        }
                    });
                }

                artistSketchesGrid.innerHTML = '';
                for (let i = 0; i < Math.min(3, artistSketches.length); i++) {
                    artistSketchesGrid.innerHTML += `<img src="${artistSketches[i].imageUrl}" alt="${artistSketches[i].name}">`;
                }

                const earlyContactMessage = `Hi ${STATE.selectedStencil.artist.name}.\n\nI'm interested in this tattoo design, and I'm waiting for the AI preview.\n\nHere is the original stencil:\n${STATE.selectedStencil.imageUrl}\n\nCan you tell me more about it?\n\nThanks!`;
                artistWhatsappLink.href = `https://wa.me/${STATE.selectedStencil.artist.whatsapp}?text=${encodeURIComponent(earlyContactMessage)}`;
                artistWhatsappLink.onclick = () => logUserEvent('WHATSAPP_CONTACT', STATE.selectedStencil.artist.id, STATE.selectedStencil.id);
                artistInfo.style.display = 'block';
            } else {
                artistInfo.style.display = 'none';
            }
            // ---

            utils.showLoading('Placing the sketch on your skin...');

            try {
                const formData = new FormData();
                formData.append('skinImage', STATE.currentImage);
                const tattooImageUrl = STATE.selectedStencil ? STATE.selectedStencil.imageUrl : STATE.uploadedTattooDesignBase64;
                const tattooDesignBlob = await (await fetch(tattooImageUrl)).blob();
                // Crucial fix: Use the correct original file type, not hardcoded 'image/jpeg'
                // Ensure the name also suggests PNG if the type is PNG
                const tattooDesignFileName = tattooDesignBlob.type === 'image/png' ? 'tattoo_design.png' : 'tattoo_design.jpeg';
                Object.defineProperty(tattooDesignBlob, 'name', { value: tattooDesignFileName });
                Object.defineProperty(tattooDesignBlob, 'type', { value: tattooDesignBlob.type }); // Retain the type from the blob (which comes from toDataURL)
                formData.append('tattooDesignImage', tattooDesignBlob);
                
                let maskToSend = STATE.currentMask;
                if (maskToSend && maskToSend.startsWith('data:')) {
                    maskToSend = maskToSend.split(',')[1];
                }
                formData.append('mask', maskToSend);
                formData.append('prompt', '');
                const rotationSlider = document.getElementById('rotationSlider');
                const angle = -rotationSlider.value; // Invert the angle for the backend
                console.log(`DEBUG: Inverting angle. Appending tattooAngle to form data: ${angle}`);
                formData.append('tattooAngle', angle);

                const sizeSlider = document.getElementById('sizeSlider');
                const scale = (parseFloat(sizeSlider.value) / 100) * 1.4; // Increase size by another 20% (total 40%)
                formData.append('tattooScale', scale);

                const response = await fetch(`${CONFIG.API_URL}/generate-final-tattoo`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${STATE.token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Renamed 'error' to 'errorData' for clarity

                    // --- START Mobile-specific JWT expired handling ---
                    // Check for 401 status and if the error message includes 'jwt expired'
                    if (response.status === 401 && (errorData.error && errorData.error.includes('jwt expired'))) {
                        utils.showError('Your session has expired. Please log in again.');
                        // Call the dedicated logout function (from auth.js)
                        if (typeof auth !== 'undefined' && auth.forceLogoutAndShowModal) {
                            auth.forceLogoutAndShowModal();
                        }
                        return; // Important: Stop execution here after handling the specific error
                    }
                    // --- END Mobile-specific JWT expired handling ---

                    // If it's not a JWT expired error, then throw the general error
                    throw new Error(errorData.error || 'Failed to generate tattoo');
                }

                const data = await response.json();
                console.log('=== API RESPONSE ===');
                console.log('Generated image URLs:', data.images);

                if (typeof data.tokens_remaining === 'number') {
                    STATE.userTokens = data.tokens_remaining;
                }
                utils.updateTokenDisplay();

                utils.hideLoading();

                STATE.generatedImages = data.images;
                const resultsGrid = document.querySelector('.results-grid');
                resultsGrid.innerHTML = STATE.generatedImages.map((imageUrl, index) => `
                    <div class="result-item">
                        <img src="${imageUrl}" alt="Generated tattoo ${index + 1}">
                        <div class="result-actions">
                            <button class="btn btn-sm btn-outline" onclick="window.open('${imageUrl}', '_blank')">View Full Size</button>
                        </div>
                    </div>
                `).join('');

                resultsSection.style.display = 'block';
                artistsSection.style.display = 'block';
                resultsSection.scrollIntoView({behavior: 'smooth'}); // Scroll to results section
                socialShareDiv.style.display = 'block';
                window.loadDemoArtistsWithFilter(); // Call global loadDemoArtistsWithFilter

                // Show and configure artist contact link if a stencil was used
                const artistContactSection = document.getElementById('artistContactSection');
                if (STATE.selectedStencil && STATE.selectedStencil.artist && artistContactSection) {
                    const whatsappLink = document.getElementById('whatsappLink');
                    const artistName = STATE.selectedStencil.artist.name;
                    const introText = `Hi ${artistName}.\n\nI got this stunning AI tattoo from your catalog. Here are the previews:\n`;
                    const imageUrlsText = STATE.generatedImages.join('\n');
                    const outroText = `\nCan you share more details about yourself and the tattoo?\n\nThanks!`;
                    const fullMessage = introText + imageUrlsText + outroText;

                    whatsappLink.href = `https://wa.me/${STATE.selectedStencil.artist.whatsapp}?text=${encodeURIComponent(fullMessage)}`;
                    whatsappLink.onclick = () => logUserEvent('WHATSAPP_CONTACT', STATE.selectedStencil.artist.id, STATE.selectedStencil.id);
                    artistContactSection.style.display = 'block';
                } else if (artistContactSection) {
                    artistContactSection.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                utils.hideLoading();
                // --- START Robust Logout for Generic Fetch Errors ---
                // If it's a TypeError (like 'Failed to fetch') or other unhandled network/API error,
                // assume session might be the issue and force logout.
                if (error.message.includes('Failed to fetch') || (error instanceof TypeError)) {
                     utils.showError('There was a network or server issue. Your session might have expired. Please log in again.');
                     if (typeof auth !== 'undefined' && auth.forceLogoutAndShowModal) {
                         auth.forceLogoutAndShowModal();
                     }
                } else if (!error.message.includes('Your session has expired')) { // Avoid double message if already handled above
                     utils.showError(`Tattoo generation failed: ${error.message}`);
                } else { // Fallback for any other unhandled errors.
                     utils.showError(`Tattoo generation failed: ${error.message}`);
                }
                // --- END Robust Logout for Generic Fetch Errors ---
            }
        });


        // Social Share to Instagram
        shareToInstagramBtn?.addEventListener('click', () => {
            if (!STATE.generatedImages || STATE.generatedImages.length === 0) {
                utils.showError('No images generated yet to share.');
                return;
            }
            alert('To share to Instagram:\n1. Right-click (or long-press on mobile) on the image(s) below to save them to your device.\n2. Open the Instagram app and upload the saved image(s) as a new post.');
        });


        // Download All button
        document.getElementById('downloadAllBtn')?.addEventListener('click', async () => {
            if (!STATE.generatedImages || STATE.generatedImages.length === 0) {
                utils.showError('No images generated to download.');
                return;
            }
            utils.showLoading('Preparing images for download...');
            for (const imageUrl of STATE.generatedImages) {
                try {
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    // IMPORTANT: Set download filename based on the actual image type, which should be PNG now
                    // Infer extension from blob.type, or assume PNG if that's what backend returns
                    const filenameExtension = blob.type.split('/')[1] || 'png';
                    a.download = `skintip_tattoo_${Date.now()}.${filenameExtension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Failed to download image:', imageUrl, error);
                    utils.showError('Failed to download one or more images.');
                    break;
                }
            }
            utils.hideLoading();
        });


        // --- General Navigation & Artist Loading ---

        // New Design button
            document.getElementById('newDesignBtn')?.addEventListener('click', () => {
                resetUI();
                document.getElementById('styleSelectionSection').scrollIntoView({ behavior: 'smooth' });
            });

            resetUI();

        // The filter event listeners for artists:
        const locationFilter = document.getElementById('locationFilter');
        const styleFilter = document.getElementById('styleFilter');
        locationFilter?.addEventListener('input', window.filterArtists);
        styleFilter?.addEventListener('change', window.filterArtists);

        // This block is intentionally left empty as the logic will be moved
        // into the results display section.

        console.log('‚úÖ SkinTip ready!');
    });
    console.log('Main inline script finished.');
</script>
</body>
</html>
