<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkinTip - AI Tattoo Visualization</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/jwt-decode/build/jwt-decode.js"></script>
    <script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.165.0/build/three.module.js",
    "three/": "https://unpkg.com/three@0.165.0/"
  }
}
</script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>SkinTip</h1>
                <span class="tagline">Try b4 you Dye</span> </div>
            <div class="nav-menu">
                <span id="userInfo" class="user-info"></span>
                <button id="logoutBtn" class="btn btn-outline" style="display:none;">Logout</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section id="tattooDesignUploadSection" class="section">
                <div class="section-header">
                    <h2>Upload Your Tattoo Design</h2>
                    <p>Choose the tattoo image you want to visualize</p>
                </div>
                
                <div class="upload-area" id="tattooDesignUploadArea">
                    <input type="file" id="tattooDesignFileInput" accept="image/jpeg,image/png,image/webp" hidden>
                    <div class="upload-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p>Click to upload or drag and drop</p>
                        <span>PNG or JPG with transparent background preferred (max. 5MB)</span>
                    </div>
                </div>

                <div id="tattooDesignPreview" class="image-preview" style="display: none;">
                    <img id="tattooDesignPreviewImg" src="" alt="Tattoo Design Preview">
                    <button id="changeTattooDesignBtn" class="btn btn-outline btn-sm">Change Design</button>
                </div>

                <div class="external-idea-guidance">
                    <div class="prompt-tip-box">
                        <p class="prompt-tip-header">üí° Pro Tip for AI Generators:</p>
                        <p class="prompt-tip-content">
                            Ask for a sketch on a **transparent background**, **NOT** a tattoo on skin. <br>
                            For example: <br>
                            "legendary king snake sketch black and white. no background. .png file"
                        </p>
                    </div>
                </div>

                <button id="continueToSkinPhotoBtn" class="btn btn-primary" style="margin-top: 2rem; display: none; margin-left: auto; margin-right: auto;">Continue to Skin Photo</button>
            </section>
            
            <section id="skinPhotoUploadSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Upload Your Photo</h2>
                    <p>Choose a photo where you want the tattoo</p>
                </div>
                
                <div class="upload-area" id="skinUploadArea">
                    <input type="file" id="fileInput" accept="image/jpeg,image/png,image/webp" hidden>
                    <div class="upload-placeholder">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p>Click to upload or drag and drop</p>
                        <span>PNG, JPG or WebP (max. 5MB)</span>
                    </div>
                </div>

                <div id="imagePreview" class="image-preview" style="display: none;">
                    <img id="previewImg" src="" alt="Skin Photo Preview">
                    <button id="changeImageBtn" class="btn btn-outline btn-sm">Change Image</button>
                </div>
            </section>

            <section id="drawingSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Mark Tattoo Area</h2>
                    <p>Use the sliders to adjust the tattoo placement and size</p>
                </div>
                
                <div class="canvas-wrapper">
                    <div class="drawing-container">
                        <canvas id="main3DCanvas" style="width:100%; height:auto; display:block; touch-action: none;"></canvas>
                        <div class="drawing-tools">
                            <div id="tattooControls" style="display: none; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 1rem; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px;">
                                <div id="angleBox" style="display:flex; align-items:center; gap:6px;">
                                    <label for="angleSlider" style="background:none; padding:0; color:white;">Angle:</label>
                                    <input type="range" id="angleSlider" min="-180" max="180" value="0" style="width:100px;">
                                    <input type="number" id="angleInput" min="-180" max="180" value="0" style="width:50px;">
                                </div>
                                <div id="sizeBox" style="display:flex; align-items:center; gap:6px;">
                                    <label for="sizeSlider" style="background:none; padding:0; color:white;">Size:</label>
                                    <input type="range" id="sizeSlider" min="0.1" max="3" step="0.01" value="1" style="width:100px;">
                                    <input type="number" id="sizeInput" min="0.1" max="3" step="0.01" value="1">
                                </div>
                                <button id="resetTattooTransformBtn" class="btn btn-outline btn-sm">Reset Transform</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button id="captureMaskBtn" class="btn btn-primary" style="margin-top: 2rem; display: block; margin-left: auto; margin-right: auto;">Generate Tattoo on Skin</button>
            </section>
            
            <section id="designSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Refine & Generate</h2>
                    <p>Final adjustments for placement</p>
                </div>

                <div class="credits-info">
                    <span id="creditsRemaining"></span>
                </div>

                <div id="socialShare" style="margin-top: 1rem; display: none;">
                    <button id="shareToInstagramBtn" class="btn btn-secondary">Share to Instagram</button>
                </div>
            </section>

            <section id="resultsSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Your Tattoo Designs</h2>
                    <p>Here are your AI-generated tattoo previews</p>
                </div>

                <div class="results-grid">
                </div>

                <div class="results-actions">
                    <button id="downloadAllBtn" class="btn btn-primary">Download All</button>
                    <button id="newDesignBtn" class="btn btn-outline">Start New Design</button>
                </div>
            </section>
            
            <section id="artistsSection" class="section" style="display: none;">
                <div class="section-header">
                    <h2>Find Your Artist</h2>
                    <p>Connect with talented tattoo artists who can bring your design to life</p>
                </div>

                <div class="filters">
                    <select id="locationFilter" class="filter-select">
                        <option value="">All Locations</option>
                        <option value="Los Angeles, CA">Los Angeles, CA</option>
                        <option value="New York, NY">New York, NY</option>
                        <option value="Austin, TX">Austin, TX</option>
                        <option value="Miami, FL">Miami, FL</option>
                        <option value="Seattle, WA">Seattle, WA</option>
                        <option value="Denver, CO">Denver, CO</option>
                        <option value="Portland, OR">Portland, OR</option>
                        <option value="Chicago, IL">Chicago, IL</option>
                    </select>
                    <select id="styleFilter" class="filter-select">
                        <option value="">All Styles</option>
                        <option value="Traditional">Traditional</option>
                        <option value="Neo-Traditional">Neo-Traditional</option>
                        <option value="Realism">Realism</option>
                        <option value="Blackwork">Blackwork</option>
                        <option value="Watercolor">Watercolor</option>
                        <option value="Japanese">Japanese</option>
                        <option value="Minimalist">Minimalist</option>
                        <option value="Geometric">Geometric</option>
                        <option value="Fine Line">Fine Line</option>
                        <option value="Tribal">Tribal</option>
                    </select>
                </div>

                <div id="artistsGrid" class="artists-grid">
                </div>
            </section>
        </div>
        <div id="statusMessage" style="position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 5px; font-size: 14px; z-index: 999; color: white;"></div>
        <div id="instructions" style="position: fixed; top: 50px; left: 10px; background: rgba(0,0,0,0.7); padding: 8px 12px; border-radius: 5px; font-size: 13px; max-width: 250px; z-index: 999; color: white;">
            **Instructions:**<br>
            1. Upload Your Tattoo Design.<br>
            2. Upload Your Photo.<br>
            3. Use **Angle Slider** for 2D rotation of tattoo content.<br>
            4. Use **Size Slider** for overall tattoo size.<br>
            5. **Drag** tattoo to move.<br>
            6. **Shift + Drag** tattoo to scale.<br>
            7. Click "Generate Tattoo on Skin".
        </div>
    </main>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText">Generating your tattoo designs...</p>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>SkinTip</h3>
                    <p>AI-powered tattoo visualization platform</p>
                </div>
                <div class="footer-section">
                    <h4>Features</h4>
                    <ul>
                        <li>AI Tattoo Generation</li>
                        <li>20+ Tattoo Styles</li>
                        <li>Artist Discovery</li>
                        <li>Direct WhatsApp Contact</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Coming Soon</h4>
                    <ul>
                        <li>Real AI Generation</li>
                        <li>Payment Integration</li>
                        <li>Artist Profiles</li>
                        <li>Mobile App</li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 SkinTip. Made with ‚ù§Ô∏è by itayash@gmail.com</p>
            </div>
        </div>
    </footer>
    <script>console.log('Loading config.js...');</script>
    <script src="js/config.js"></script>
    <script>console.log('Loading auth.js...');</script>
    <script src="js/auth.js"></script>
    <script>console.log('Loading drawing.js...');</script>
    <script type="module" src="js/drawing.js"></script>
    <script>
        console.log('Main inline script starting...');

        /**
         * Resizes an image Data URL to a maximum width/height while maintaining aspect ratio.
         * Returns a Promise that resolves with the new Data URL.
         * @param {string} dataURL The input image data URL.
         * @param {string} originalMimeType The original MIME type of the file (e.g., 'image/png').
         * @param {number} maxWidth Max width for the resized image.
         * @param {number} maxHeight Max height for the resized image.
         * @param {number} quality JPEG compression quality (0-1), ignored for PNG.
         * @returns {Promise<string>} Promise resolving with the resized image Data URL.
         */
        function resizeImage(dataURL, originalMimeType, maxWidth, maxHeight, quality = 0.9) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;

                    // Calculate new dimensions
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');

                    // Crucial for transparency: Clear canvas to transparent black
                    ctx.clearRect(0, 0, canvas.width, canvas.height); // Clears to transparent black

                    ctx.drawImage(img, 0, 0, width, height);

                    // If original was PNG or WebP, aim for PNG output to preserve transparency, otherwise JPEG
                    const outputMimeType = (originalMimeType === 'image/png' || originalMimeType === 'image/webp') ? 'image/png' : 'image/jpeg';
                    const outputQuality = outputMimeType === 'image/jpeg' ? quality : undefined;

                    resolve(canvas.toDataURL(outputMimeType, outputQuality));
                };
                img.src = dataURL;
            });
        }


        // --- Artist Loading and Filtering Functions (MOVED TO GLOBAL SCOPE) ---
        let allArtists = []; // Declare in a scope accessible by filterArtists and displayArtists

        // Function definitions for contactArtist, changePortfolioImage, loadDemoArtistsWithFilter,
        // displayArtists, and filterArtists are assigned to window for global accessibility
        window.contactArtist = function(whatsapp, name) {
            const message = `Hi ${name}, I'm interested in getting a tattoo! Can you help me visualize this? (from SkinTip.AI)`;
            window.open(`https://wa.me/${whatsapp}?text=${encodeURIComponent(message)}`, '_blank');
        };

        window.changePortfolioImage = function(button, direction) {
            const gallery = button.closest('.portfolio-gallery');
            const images = Array.from(gallery.querySelectorAll('.portfolio-image'));
            let currentIndex = images.findIndex(img => img.classList.contains('active'));

            images[currentIndex].style.display = 'none';
            images[currentIndex].classList.remove('active');

            currentIndex = (currentIndex + direction + images.length) % images.length;

            images[currentIndex].style.display = 'block';
            images[currentIndex].classList.add('active');
        };

        window.loadDemoArtistsWithFilter = function() {
            allArtists = [
                {
                    name: 'Sarah Martinez',
                    location: 'Los Angeles, CA',
                    styles: ['Fine Line', 'Minimalist', 'Geometric'],
                    bio: 'Specializing in delicate designs with 10+ years experience',
                    likes: 234,
                    whatsapp: '+1234567890',
                    portfolio: [
                        'https://images.unsplash.com/photo-1611501275019-9b5cda994e8d',
                        'https://images.unsplash.com/photo-1598371839696-5c5bb00bdc28',
                        'https://images.unsplash.com/photo-1567406889330-43e4639e8d4f',
                        'https://images.unsplash.com/photo-1475695752828-6d2b0a83cf8a'
                    ]
                },
                {
                    name: 'Mike Chen',
                    location: 'New York, NY',
                    styles: ['Japanese', 'Neo-Traditional'],
                    bio: 'Award-winning traditional Japanese artist',
                    likes: 189,
                    whatsapp: '+0987654321',
                    portfolio: [
                        'https://images.unsplash.com/photo-1565058379802-bbe93b2f703a',
                        'https://images.unsplash.com/photo-1540202403-b7abd6747a18',
                        'https://images.unsplash.com/photo-1582736317441-e6937f84b6b3',
                        'https://images.unsplash.com/photo-1552627019-947c3789ffb5'
                    ]
                },
                {
                    name: 'Emma Thompson',
                    location: 'Austin, TX',
                    styles: ['Watercolor', 'Abstract'],
                    bio: 'Creating unique watercolor tattoos since 2015',
                    likes: 156,
                    whatsapp: '+1122334455',
                    portfolio: [
                        'https://images.unsplash.com/photo-1598371839696-5c5bb00bdc28',
                        'https://images.unsplash.com/photo-1604881991720-f91add269bed',
                        'https://images.unsplash.com/photo-1590736969955-71cc94901144',
                        'https://images.unsplash.com/photo-1611501275019-9b5cda994e8d'
                    ]
                },
                {
                    name: 'Carlos Rodriguez',
                    location: 'Miami, FL',
                    styles: ['Blackwork', 'Geometric', 'Tribal'],
                    bio: 'Bold designs with precision and passion',
                    likes: 298,
                    whatsapp: '+9988776655',
                    portfolio: [
                        'https://images.unsplash.com/photo-1590736969955-71cc94901144',
                        'https://images.unsplash.com/photo-1568515045052-f9a854d70bfd',
                        'https://images.unsplash.com/photo-1582731478949-884de7283343',
                        'https://images.unsplash.com/photo-1604881991720-f91add269bed'
                ]
                }
            ]; // Correctly closing allArtists array
            window.displayArtists(allArtists);
        };

        window.displayArtists = function(artists) {
            const artistsGrid = document.getElementById('artistsGrid');
            if (artists.length === 0) {
                artistsGrid.innerHTML = '<div class="empty-state"><p>No artists found matching your criteria</p></div>';
                return;
            }
            artistsGrid.innerHTML = artists.map(artist => {
                let portfolioImages = '';
                if (Array.isArray(artist.portfolio)) {
                    portfolioImages = artist.portfolio.map((img, index) =>
                        `<img src="${img}" alt="${artist.name} work ${index + 1}"
                             class="portfolio-image ${index === 0 ? 'active' : ''}"
                             style="display: ${index === 0 ? 'block' : 'none'}">`
                    ).join('');
                } else {
                    portfolioImages = `<img src="${artist.portfolio}" alt="${artist.name}" class="portfolio-image active" style="display: block">`;
                }
                const stylesHTML = artist.styles.map(style =>
                    `<span class="style-tag">${style}</span>`
                ).join('');
                return `
                    <div class="artist-card">
                        <div class="portfolio-gallery">
                            ${portfolioImages}
                            <button class="gallery-prev" onclick="changePortfolioImage(this, -1)">‚Äπ</button>
                            <button class="gallery-next" onclick="changePortfolioImage(this, 1)">‚Ä∫</button>
                        </div>
                        <div class="artist-info">
                            <h3>${artist.name}</h3>
                            <p class="artist-location">üìç ${artist.location}</p>
                            <p class="artist-bio">${artist.bio}</p>
                            <div class="artist-styles">
                                ${stylesHTML}
                            </div>
                            <div class="artist-footer">
                                <span class="artist-likes">‚ù§Ô∏è ${artist.likes}</span>
                                <button class="btn btn-primary btn-sm" onclick="contactArtist('${artist.whatsapp}', '${artist.name}')">
                                    Contact via WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        };

        window.filterArtists = function() {
            const locationFilter = document.getElementById('locationFilter');
            const styleFilter = document.getElementById('styleFilter');
            const selectedLocation = locationFilter ? locationFilter.value : '';
            const selectedStyle = styleFilter ? styleFilter.value : '';

            const filtered = allArtists.filter(artist => {
                const matchesLocation = !selectedLocation || artist.location === selectedLocation;
                const matchesStyle = !selectedStyle || artist.styles.includes(selectedStyle);
                return matchesLocation && matchesStyle;
            });
            window.displayArtists(filtered);
        };
        // --- END ARTIST FUNCTIONS GLOBAL SCOPE ---


        document.addEventListener('DOMContentLoaded', () => {
            console.log('üé® SkinTip initializing (DOMContentLoaded)!');

            // Initialize auth module (handles redirection for authenticated users)
            if (typeof auth !== 'undefined' && auth.init) {
                auth.init();
            } else {
                console.error("Auth
