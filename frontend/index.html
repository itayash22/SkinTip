// frontend/js/auth.js

// Ensure API_BASE_URL is defined from config.js
if (typeof API_BASE_URL === 'undefined') {
    console.error("API_BASE_URL is not defined. Make sure config.js is loaded before auth.js and defines window.API_BASE_URL.");
}

// Function to update the user info display in the navbar
window.updateUserTokensDisplay = (tokens) => {
    const userInfoSpan = document.getElementById('userInfo');
    const userName = localStorage.getItem('userName') || localStorage.getItem('userEmail');
    if (userName && tokens !== undefined) {
        userInfoSpan.textContent = `Welcome, ${userName}! Tokens: ${tokens}`;
        userInfoSpan.style.display = 'inline';
    } else if (userName) {
        userInfoSpan.textContent = `Welcome, ${userName}!`;
        userInfoSpan.style.display = 'inline';
    } else {
        userInfoSpan.textContent = '';
        userInfoSpan.style.display = 'none';
    }
};

// Function to handle user login
window.loginUser = async (email, password) => {
    try {
        const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (response.ok) {
            console.log('Login successful:', data);
            // This function is now defined in index.html and needs to be called
            if (window.handleAuthSuccess) {
                window.handleAuthSuccess(data.user, data.token);
            } else {
                console.error("window.handleAuthSuccess is not defined. UI may not update correctly.");
                localStorage.setItem('jwtToken', data.token);
                localStorage.setItem('userEmail', data.user.email);
                localStorage.setItem('userName', data.user.username);
                window.updateUserTokensDisplay(data.user.tokens_remaining);
                // Redirect or change section manually if handleAuthSuccess is missing
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('tattooDesignUploadSection').style.display = 'block';
            }
        } else {
            console.error('Login failed:', data.error);
            if (window.displayAuthError) {
                window.displayAuthError(data.error || 'Login failed. Please check your credentials.');
            }
        }
    } catch (error) {
        console.error('Network or server error during login:', error);
        if (window.displayAuthError) {
            window.displayAuthError('Network error or server unavailable. Please try again.');
        }
    }
};

// Function to handle user registration
window.registerUser = async (email, password, username) => {
    try {
        const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password, username })
        });

        const data = await response.json();

        if (response.ok) {
            console.log('Registration successful:', data);
            if (window.handleAuthSuccess) {
                window.handleAuthSuccess(data.user, data.token);
            } else {
                console.error("window.handleAuthSuccess is not defined. UI may not update correctly.");
                localStorage.setItem('jwtToken', data.token);
                localStorage.setItem('userEmail', data.user.email);
                localStorage.setItem('userName', data.user.username);
                window.updateUserTokensDisplay(data.user.tokens_remaining);
                // Redirect or change section manually if handleAuthSuccess is missing
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('tattooDesignUploadSection').style.display = 'block';
            }
        } else {
            console.error('Registration failed:', data.error);
            if (window.displayAuthError) {
                window.displayAuthError(data.error || 'Registration failed. Please try again.');
            }
        }
    } catch (error) {
        console.error('Network or server error during registration:', error);
        if (window.displayAuthError) {
            window.displayAuthError('Network error or server unavailable. Please try again.');
        }
    }
};

// Function to handle user logout
window.logoutUser = () => {
    localStorage.removeItem('jwtToken');
    localStorage.removeItem('userEmail');
    localStorage.removeItem('userName');
    document.getElementById('userInfo').textContent = '';
    document.getElementById('logoutBtn').style.display = 'none';
    console.log('User logged out.');
    // The index.html DOMContentLoaded listener will handle showing auth section
};

// Function to check authentication status and fetch tokens on page load
window.checkAuthStatus = async () => {
    const token = localStorage.getItem('jwtToken');
    if (token) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/user/tokens`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                window.updateUserTokensDisplay(data.tokensRemaining);
                document.getElementById('logoutBtn').style.display = 'block'; // Ensure logout button is visible if authenticated
            } else {
                // Token invalid or expired, force logout
                console.warn('Authentication check failed, logging out:', response.status);
                window.logoutUser();
                if (window.showSection) window.showSection('authSection'); // Go back to auth
            }
        } catch (error) {
            console.error('Error checking auth status:', error);
            window.logoutUser(); // Logout on network error too
            if (window.showSection) window.showSection('authSection');
        }
    } else {
        // No token, ensure UI is in logged-out state
        window.logoutUser(); // Clears display
        if (window.showSection) window.showSection('authSection');
    }
};

// Call checkAuthStatus on initial load
document.addEventListener('DOMContentLoaded', () => {
    window.checkAuthStatus();
});
