<script>
    console.log('Main inline script starting...');

    // ... (your existing resizeImage function and artist functions) ...

    document.addEventListener('DOMContentLoaded', () => {
        console.log('ðŸŽ¨ SkinTip initializing (DOMContentLoaded)!');

        // ... (your existing UI element references and resetUI function) ...

        // Continue from Drawing to Design (NOW DIRECTLY GENERATES)
        continueBtn?.addEventListener('click', async () => { // Changed to async
            // Ensure user is logged in
            if (!STATE.user || !STATE.token) {
                utils.showError('You must be logged in to generate tattoos.');
                auth.showModal();
                return;
            }

            if (!STATE.userTokens || STATE.userTokens < CONFIG.TOKEN_COSTS.FLUX_PLACEMENT) {
                utils.showError(`Not enough tokens! This action costs ${CONFIG.TOKEN_COSTS.FLUX_PLACEMENT} tokens. You have ${STATE.userTokens || 0}.`);
                return;
            }
            if (!STATE.uploadedTattooDesignBase64) {
                utils.showError('Please upload a tattoo design first.');
                return;
            }
            // IMPORTANT: STATE.currentImage currently holds a File/Blob object from handleSkinPhotoFile.
            // We need its Base64 representation.
            if (!STATE.currentImage) { // This check should be for the Base64 version
                utils.showError('Please upload your skin photo first.');
                return;
            }
            if (!window.drawing || !drawing.selectedArea) {
                utils.showError('Please mark the tattoo area on your photo before generating.');
                return;
            }

            // Ensure mask is set (already handled by drawing.js)
            STATE.currentMask = drawing.selectedArea; // This is already a Data URL (base64 string)

            utils.showLoading('Generating your tattoo designs...');

            try {
                // --- CRITICAL CHANGE START ---
                // Convert STATE.currentImage (File/Blob) to Base64 Data URL if it's not already
                let skinImageBase64 = STATE.currentImage; // Assume it's already a Data URL if previously resized
                if (STATE.currentImage instanceof Blob) { // If it's a Blob/File, convert it to Base64
                    skinImageBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(STATE.currentImage);
                    });
                }
                // --- CRITICAL CHANGE END ---

                const requestBody = {
                    skinImageBase64: skinImageBase64,
                    tattooDesignBase64: STATE.uploadedTattooDesignBase64,
                    maskBase64: STATE.currentMask, // This is already Data URL, backend expects Base64, but it handles the prefix
                    prompt: '' // Or whatever dynamic prompt you might add later
                };

                const response = await fetch(`${CONFIG.API_URL}/generate-final-tattoo`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // IMPORTANT: Specify JSON content type
                        'Authorization': `Bearer ${STATE.token}`
                    },
                    body: JSON.stringify(requestBody) // Send as JSON string
                });

                if (!response.ok) {
                    const errorData = await response.json(); // Parse error response as JSON
                    throw new Error(errorData.message || errorData.error || 'Failed to generate tattoo');
                }

                const data = await response.json();
                console.log('=== API RESPONSE ===');
                console.log('Generated image URLs:', data.images);

                if (typeof data.tokens_remaining === 'number') {
                    STATE.userTokens = data.tokens_remaining;
                }
                utils.updateTokenDisplay();

                utils.hideLoading();

                STATE.generatedImages = data.images;
                const resultsGrid = document.querySelector('.results-grid');
                resultsGrid.innerHTML = STATE.generatedImages.map((imageUrl, index) => `
                    <div class="result-item">
                        <img src="${imageUrl}" alt="Generated tattoo ${index + 1}">
                        <div class="result-actions">
                            <button class="btn btn-sm btn-outline" onclick="window.open('${imageUrl}', '_blank')">View Full Size</button>
                        </div>
                    </div>
                `).join('');

                resultsSection.style.display = 'block';
                artistsSection.style.display = 'block';
                resultsSection.scrollIntoView({behavior: 'smooth'});
                socialShareDiv.style.display = 'block';
                window.loadDemoArtistsWithFilter();

            } catch (error) {
                console.error('Generation error:', error);
                utils.hideLoading();
                utils.showError(error.message);
            }
        });

        // ... (rest of your event listeners and DOMContentLoaded code) ...
    });
    console.log('Main inline script finished.');
</script>
